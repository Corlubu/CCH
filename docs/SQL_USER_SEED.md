# SQL Sequence for Seeding Administrator and Staff Users

## Overview

This document provides the raw SQL INSERT statements required to manually seed the default Administrator and Staff users into the PostgreSQL database. These statements replicate the functionality of the `src/server/scripts/setup.ts` script.

## Quick Start

**⚠️ IMPORTANT:** You must generate the actual password hash before running the SQL statements.

### Step 1: Generate the Password Hash and SQL

Run the password hash generator script:

```bash
node scripts/generate-password-hash.js "Admincch@2025" 10
```

This will output:
- The bcrypt password hash
- Complete SQL INSERT statements with the hash
- A ready-to-execute SQL transaction

### Step 2: Copy and Execute the SQL

Copy the SQL transaction from the script output and execute it in your PostgreSQL database.

### Step 3: Verify

```sql
SELECT "username", "role", "fullName", "email" 
FROM "User" 
WHERE "role" IN ('ADMIN', 'STAFF');
```

---

## Important Notes

- **Password hashes shown below are PLACEHOLDERS** - You must generate the actual hash using the script
- The default password is: `Admincch@2025` (from the `ADMIN_PASSWORD` environment variable)
- The hashes use bcrypt with 10 salt rounds (from `BCRYPT_ROUNDS=10`)
- If you change the `ADMIN_PASSWORD` environment variable, regenerate the hash with the new password
- These SQL statements should only be run once during initial setup
- The automated setup script (`src/server/scripts/setup.ts`) is preferred in most cases

## SQL INSERT Statements (Templates)

**⚠️ WARNING:** The password hash shown below (`PLACEHOLDER_HASH`) is NOT valid. You MUST replace it with an actual bcrypt hash generated by running `node scripts/generate-password-hash.js`.

### Prerequisites

Ensure the `UserRole` enum exists:
```sql
CREATE TYPE "UserRole" AS ENUM ('ADMIN', 'STAFF', 'CITIZEN');
```

### Insert Administrator User

```sql
INSERT INTO "User" (
  "username",
  "passwordHash",
  "role",
  "fullName",
  "email",
  "isActive",
  "createdAt"
) VALUES (
  'admin',
  'PLACEHOLDER_HASH',  -- ⚠️ Replace with actual hash from generate-password-hash.js
  'ADMIN',
  'System Administrator',
  'admin@foodbank.church',
  true,
  NOW()
) ON CONFLICT ("username") DO NOTHING;
```

### Insert Staff User

```sql
INSERT INTO "User" (
  "username",
  "passwordHash",
  "role",
  "fullName",
  "email",
  "isActive",
  "createdAt"
) VALUES (
  'staff',
  'PLACEHOLDER_HASH',  -- ⚠️ Replace with actual hash from generate-password-hash.js
  'STAFF',
  'Staff User',
  'staff@foodbank.church',
  true,
  NOW()
) ON CONFLICT ("username") DO NOTHING;
```

**Note:** The `ON CONFLICT ("username") DO NOTHING` clause prevents errors if these users already exist.

## Generating Password Hash

### Method 1: Using the Password Hash Generator Script (Recommended)

The easiest way to generate the password hash and SQL statements is to use the provided script:

```bash
node scripts/generate-password-hash.js
```

**With custom password:**
```bash
node scripts/generate-password-hash.js "YourPassword123" 10
```

**Arguments:**
- First argument: Password (default: `Admincch@2025`)
- Second argument: Salt rounds (default: `10`)

**Output includes:**
- The generated bcrypt hash
- Complete SQL INSERT statements with the hash already inserted
- A ready-to-execute SQL transaction
- Usage instructions

**Example output:**
```
================================================================================
Password Hash Generator for SQL User Seeding
================================================================================

Input:
  Password: Admincch@2025
  Salt Rounds: 10

Generating hash...

Generated Hash:
  $2a$10$XYZ123...abc789

================================================================================
SQL INSERT Statements
================================================================================

-- Insert Administrator User
INSERT INTO "User" (
  "username",
  "passwordHash",
  "role",
  "fullName",
  "email",
  "isActive",
  "createdAt"
) VALUES (
  'admin',
  '$2a$10$XYZ123...abc789',
  'ADMIN',
  'System Administrator',
  'admin@foodbank.church',
  true,
  NOW()
) ON CONFLICT ("username") DO NOTHING;

... (more output)
```

### Method 2: Using Node.js Directly

If you need just the hash without the SQL statements:

```javascript
const bcryptjs = require('bcryptjs');

async function generateHash() {
  const hash = await bcryptjs.hash('Admincch@2025', 10);
  console.log(hash);
}

generateHash();
```

### Method 3: Using the Setup Script (Automated)

The recommended approach for normal operation is to use the setup script, which automatically handles password hashing:

```bash
npm run setup
```

Or if running in Docker:
```bash
docker-compose exec app npm run setup
```

This script automatically:
- Hashes the password from `ADMIN_PASSWORD` environment variable
- Creates or updates the admin and staff users
- Initializes admin settings
- Handles all edge cases

## Complete SQL Transaction (Template)

**⚠️ IMPORTANT:** Run `node scripts/generate-password-hash.js` to get the actual SQL with a valid password hash. The template below uses a placeholder.

```sql
BEGIN;

-- Insert Administrator User
INSERT INTO "User" (
  "username",
  "passwordHash",
  "role",
  "fullName",
  "email",
  "isActive",
  "createdAt"
) VALUES (
  'admin',
  'PLACEHOLDER_HASH',  -- ⚠️ Replace with actual hash
  'ADMIN',
  'System Administrator',
  'admin@foodbank.church',
  true,
  NOW()
) ON CONFLICT ("username") DO NOTHING;

-- Insert Staff User
INSERT INTO "User" (
  "username",
  "passwordHash",
  "role",
  "fullName",
  "email",
  "isActive",
  "createdAt"
) VALUES (
  'staff',
  'PLACEHOLDER_HASH',  -- ⚠️ Replace with actual hash
  'STAFF',
  'Staff User',
  'staff@foodbank.church',
  true,
  NOW()
) ON CONFLICT ("username") DO NOTHING;

COMMIT;
```

**To get the actual SQL with valid hashes:**
```bash
node scripts/generate-password-hash.js "Admincch@2025" 10
```

## Verification

After running the SQL statements, verify the users were created:

```sql
SELECT 
  "id",
  "username",
  "role",
  "fullName",
  "email",
  "isActive",
  "createdAt"
FROM "User"
WHERE "role" IN ('ADMIN', 'STAFF')
ORDER BY "role", "username";
```

Expected output:
```
 id | username | role  |       fullName        |          email           | isActive |         createdAt          
----+----------+-------+-----------------------+--------------------------+----------+----------------------------
  1 | admin    | ADMIN | System Administrator  | admin@foodbank.church    | t        | 2025-01-08 12:00:00.000
  2 | staff    | STAFF | Staff User            | staff@foodbank.church    | t        | 2025-01-08 12:00:00.000
```

## Testing Login

After seeding, test the login:

### Admin Login
- **Username:** `admin`
- **Password:** `Admincch@2025` (or your custom password)
- **Role:** ADMIN

### Staff Login
- **Username:** `staff`
- **Password:** `Admincch@2025` (or your custom password)
- **Role:** STAFF

## Troubleshooting

### Error: "duplicate key value violates unique constraint"

This means the users already exist. You can either:
1. Skip this error (the users are already seeded)
2. Update the existing users' passwords (replace `PLACEHOLDER_HASH` with your actual hash):

```sql
UPDATE "User"
SET "passwordHash" = 'PLACEHOLDER_HASH'  -- ⚠️ Replace with actual hash
WHERE "username" IN ('admin', 'staff');
```

### Error: "type 'UserRole' does not exist"

Create the enum first:
```sql
CREATE TYPE "UserRole" AS ENUM ('ADMIN', 'STAFF', 'CITIZEN');
```

### Login Fails with Correct Password

1. Verify the password hash was generated correctly:
   ```bash
   node scripts/generate-password-hash.js "Admincch@2025" 10
   ```

2. Check the password hash in the database:
   ```sql
   SELECT "username", "passwordHash" FROM "User" WHERE "username" = 'admin';
   ```

3. Ensure the password hash in the database matches the one generated by the script

4. Verify the `ADMIN_PASSWORD` environment variable matches the password you used to generate the hash

5. Ensure `BCRYPT_ROUNDS` is set to `10` (or use the same number when generating the hash)

### Hash Looks Wrong or Too Short

A valid bcrypt hash should:
- Start with `$2a$` or `$2b$`
- Be approximately 60 characters long
- Look like: `$2a$10$N9qo8uLOickgx2ZMRZoMye.IcQ8.XvLIxpXpX6vXpXpXpXpXpXpXp`

If your hash doesn't match this pattern, regenerate it using the script.

## Security Considerations

### Production Deployment

⚠️ **CRITICAL:** Before deploying to production:

1. **Change the default password** in the `.env` file:
   ```bash
   ADMIN_PASSWORD=your_secure_password_here
   ```

2. **Use a strong password** that includes:
   - At least 12 characters
   - Uppercase and lowercase letters
   - Numbers
   - Special characters

3. **Regenerate the password hash** using the methods above

4. **Secure the `.env` file:**
   - Never commit `.env` to version control (it's in `.gitignore`)
   - Restrict file permissions: `chmod 600 .env`
   - Use environment-specific configuration management in production

### Password Hash Security

- **Bcrypt is secure:** The bcrypt algorithm automatically includes a salt
- **10 rounds is sufficient:** This provides good security while maintaining performance
- **Hashes are unique:** Even with the same password, each hash will be different due to the random salt
- **One-way encryption:** Password hashes cannot be reversed to obtain the original password

### Default Credentials

The default credentials are:
- **Admin:** username `admin`, password `Admincch@2025`
- **Staff:** username `staff`, password `Admincch@2025`

These should be changed immediately after initial setup in any production environment.

## Related Files

- **Setup Script:** `src/server/scripts/setup.ts` - Automated version of this seeding process
- **Prisma Schema:** `prisma/schema.prisma` - Database schema definition
- **Environment Config:** `src/server/env.ts` - Environment variable validation
- **Login Procedure:** `src/server/trpc/procedures/login.ts` - Handles user authentication
- **Environment File:** `.env` - Contains `ADMIN_PASSWORD` and `BCRYPT_ROUNDS`

## Additional Setup

The setup script also initializes:

### Admin Settings
```sql
INSERT INTO "AdminSettings" (
  "id",
  "registrationCooldownEnabled",
  "registrationCooldownDays",
  "createdAt",
  "updatedAt"
) VALUES (
  1,
  true,
  14,
  NOW(),
  NOW()
) ON CONFLICT ("id") DO NOTHING;
```

This is handled automatically by `src/server/scripts/setup.ts` and typically doesn't need manual intervention.

## Summary

This document provides the SQL INSERT statements to manually seed the administrator and staff users. However, the recommended approach is to use the automated setup script (`npm run setup`), which:
- Automatically hashes passwords
- Handles updates to existing users
- Initializes admin settings
- Marks expired events as completed
- Provides better error handling and logging

Use these SQL statements only when:
- Manual database initialization is required
- Debugging database seeding issues
- Understanding the underlying database structure
- Working with database migrations or backups
