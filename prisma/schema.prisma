// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://postgres:Postgresql@2025@localhost:5432/app" // hardcoded because it's an internal docker connection
}

enum UserRole {
  ADMIN
  STAFF
  CITIZEN
}

enum EventStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

model User {
  id            Int            @id @default(autoincrement())
  username      String         @unique
  passwordHash  String
  role          UserRole
  fullName      String
  email         String?
  phoneNumber   String?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  registrations Registration[]
  preferences   UserPreferences?
  citizenProfile CitizenProfile?

  @@index([username])
  @@index([role])
  @@index([phoneNumber])
}

model UserPreferences {
  id                      Int      @id @default(autoincrement())
  userId                  Int      @unique
  emailNotifications      Boolean  @default(true)
  smsNotifications        Boolean  @default(true)
  eventReminders          Boolean  @default(true)
  theme                   String   @default("light")
  language                String   @default("en")
  timezone                String   @default("America/New_York")
  createdAt               DateTime @default(now())

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CitizenProfile {
  id                Int            @id @default(autoincrement())
  phoneNumber       String         @unique
  firstName         String
  middleName        String?
  lastName          String
  email             String?
  isHomeless        Boolean        @default(false)
  address           String?
  apartmentSuite    String?
  cityTown          String?
  stateProvince     String?
  zipPostalCode     String?
  country           String?
  county            String?
  userId            Int?           @unique
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  user              User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  registrations     Registration[]

  @@index([phoneNumber])
  @@index([userId])
}

model Event {
  id               Int            @id @default(autoincrement())
  name             String
  description      String?
  availableBags    Int
  registeredCount  Int            @default(0)
  startDatetime    DateTime
  endDatetime      DateTime
  status           EventStatus    @default(ACTIVE)
  createdAt        DateTime       @default(now())
  registrations    Registration[]
  qrSessions       QRSession[]

  @@index([status])
  @@index([startDatetime])
  @@index([endDatetime])
}

model Registration {
  id              Int      @id @default(autoincrement())
  orderNumber     String   @unique
  firstName       String   @default("")
  middleName      String?
  lastName        String   @default("")
  isHomeless      Boolean  @default(false)
  totalIndividuals Int     @default(1)
  address         String?
  apartmentSuite  String?
  cityTown        String?
  stateProvince   String?
  zipPostalCode   String?
  country         String?
  county          String?
  digitalSignature String?
  alternatePickupPerson String?
  incomeEligibility Boolean @default(false)
  snap            Boolean  @default(false)
  tanf            Boolean  @default(false)
  ssi             Boolean  @default(false)
  medicaid        Boolean  @default(false)
  incomeSalary    Int?
  phoneNumber     String
  email           String?
  eventId         Int
  userId          Int?
  citizenProfileId Int?
  registeredBy    String   @default("self")
  registrationDate DateTime @default(now())
  checkedIn       Boolean  @default(false)
  checkedInAt     DateTime?

  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  citizenProfile  CitizenProfile? @relation(fields: [citizenProfileId], references: [id], onDelete: SetNull)

  @@index([phoneNumber])
  @@index([orderNumber])
  @@index([eventId])
  @@index([registrationDate])
  @@index([citizenProfileId])
}

model QRSession {
  id          Int      @id @default(autoincrement())
  sessionCode String   @unique
  eventId     Int
  expiresAt   DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([sessionCode])
  @@index([eventId])
  @@index([expiresAt])
}

model AdminSettings {
  id                              Int      @id @default(1)
  registrationCooldownEnabled     Boolean  @default(true)
  registrationCooldownDays        Int      @default(14)
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
}
